---
title: "Assessing Class Size Effect on Math Scores for First Graders"
output: 
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: yes
    toc: true
    toc_float:
      collapsed: false
    fig caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
***

Team ID: 4

Min Kim ()

Kenneth Broadhead ()

Nanhao Chen ()

Koral Buch ()

***

# Introduction
## Background

The Student/Teacher Achievement Ratio (STAR) Project was a four-year study in the late 1980s in Tennessee, which assessed the effect of class size on the students’ academic performance (math and reading scores) of the Stanford Achievement Test (SAT). The study consisted of students from kindergarten with continuation to third grade and teachers being randomly assigned to one of three class types:

* [Control group] regular class (22 to 25 students per teacher)

* [Treatment group I] small class (13 to 17 students per teacher)

* [Treatment group II] regular-with-aide class (22 to 25 students with a full-time teacher's aide)

The study provides additional information about the students, such as gender and ethnicity, and the teachers, such as a number of years of experience and level of education. The effect of these variables on the test scores can be estimated as well.

## Objective
In this project, we analyze the data from Project STAR, focusing on first grade. The primary question of interest is whether class type affects the students’ math scores in the SAT. In this project, we would like to estimate the change in the math score for each treatment group given the control group.

## Statistical Analysis
To answer our main question of interest, we designed a one-way ANOVA model and obtained basic properties. The dependent variable is the math test scores for first grade, and the independent variable is the class type. For statistical inference, we tested the null hypothesis among the different groups.

# Results
## Missing Values
The data contain 11,598 observations. We are interested only in those that have data for the relevant treatment, i.e. have values or the star1 variable. We therefore trim the data set accordingly. Of the remaining 6829, there are 229 observations that do not have a first grade math score (**math1**). Due to the large number of observations, we simply delete these observations. We first investigate whether or not these observations can be considered as random, or if there is some problematic bias that might be introduced by deleting them. We investigate the variables pertaining to **gender**, **location**, **ethnicity**, and possible economic indicators (free lunch, **lunch1**). The only variable posing a potential problem is the free lunch variable, where a larger proportion of students missing a **math1** qualified for free lunch than those in the complete (no missing values) data set.  However, this difference is not too extreme. Plus, the portion of free lunch in the remaining data is consistent with the original data; we thus think it appropriate to proceed with further analysis. This should be noted for follow up studies and may need to be investigated further. The other variables considered showed a roughly similar distribution between the students missing a **math1** score, and those who had one recorded.

```{r message=FALSE, include=FALSE}
library(AER)
library(kableExtra)
library(tidyverse)
data("STAR")
```

```{r}
STAR$star1 <- as.factor(STAR$star1)
# create a subset for 1st grade with removing all the NA data in star1 and math1
subset1 <- subset(STAR, (!is.na(STAR$star1))&(!is.na(STAR$math1)))
# create a subset for 1st grade with removing all the NA data in star1 and keep NA in math1
subset1_NA <- subset(STAR, (!is.na(STAR$star1))&(is.na(STAR$math1)))
```

## Descriptive Analysis
Figure 1 - 3 show summary statistics of **math1** (math scores) and **star1** (class type) variables. The distributions of each math score population seems to be approximately normal. Summary statistics for other potentially relevant (but unanalyzed in this report) variables are found above, such as **gender**, **ethnicity**, and others variables, in the analysis for roughly equal distributions between students with remaining and recorded **math1** scores. According to the boxplot in Figure 3, the **math1** scores of different class types suggest that class types has an effect on the average of the mathematics scores, and the standard deviations of each population appear to be similar.

Since teachers were randomly assigned to classes, these confounding variables, such as **degree1** and **ladder**, can be ignored in this analysis. Furthermore, the approximate normalities and equal variances of math score distributions suggest that an one-way ANOVA model is appropriate to investigate the effects of the class type on mathematics scores.

```{r fig.cap="Figure 1: Histograms of 1st grade math scores by different class types."}
par(mfrow=c(2,2), pty="s", xpd = NA)
hist(subset1$math1[subset1$star1=='regular'], main='Control Group (Regular)', xlab='1st grade math score')
hist(subset1$math1[subset1$star1=='small'], main='Treatment Group I (Small)', xlab='1st grade math score')
hist(subset1$math1[subset1$star1=='regular+aide'], main='Treatment Group II (Regular+Aide)', xlab='1st grade math score')
```

```{r fig.cap = "Figure 2. Pie charts of the class types, gender, eligibility for free lunch, and school type."}
# par(mfrow=c(2,2), mar = c(4,3.5,1,1.5), mgp=c(1.5,0.5,0), cex = 0.8, pty="s")
par(mfrow=c(4,2), mar = c(3,1,0.7,0), mgp=c(0.5,1,0), cex = 0.8, pty="s") 
pie(table(STAR$star1), xlab='All Grades')
title("Class Type")
pie(table(subset1$star1), xlab='1st Grade')
pie(table(STAR$gender), xlab='All Grades')
title("Gender")
pie(table(subset1$gender), xlab='1st Grade')
pie(table(STAR$lunch1), xlab='All Grades')
title("Eligibility for Free Lunch")
pie(table(subset1$lunch1), xlab='1st Grade')
pie(table(STAR$school1), xlab='All Grades')
title("School Type")
pie(table(subset1$school1), xlab='1st Grade')
```

```{r fig.cap = "Figure 3. Box plot of the distribution of 1st grade math scores by different class type."}
par(mfrow=c(1,1))
boxplot(subset1$math1~subset1$star1, main='The distribution of 1st grade math scores by different class type ',xlab='Class Type', ylab='Math Scores',col=(c('red','blue','green')))
```

```{r}
subset1 %>% group_by("Class Type" = star1) %>% summarise(Count = n(),
                                                         "Min." = min(math1),
                                                         "1st Qu." = quantile(math1, 0.25),
                                          Mean = mean(math1),
                                          Median = median(math1),
                                          "3rd Qu." = quantile(math1, 0.25),
                                          "Max." = max(math1)) %>%
  kable(caption = "Math Scores Summary Statistics") %>%
  kable_styling(full_width = F)
```


## Inferential Analyses and Model Diagnoses
Here is the one-way ANOVA model we employed for the analysis:
$Y_{ij} = \mu_{i} + \varepsilon_{ij},$      $j=1,...,n_{i};i=1,...,r$

where:

  *$Y_{ij}$* is the value of the response variabl in the *j*th observation for the *i*th Class Type;

  *$\mu_{i}$* is the means of the *i*th Class Type;

  *$\varepsilon_{ij}$*'s are random errors, normally distributed with cosntant variance;
  
  *$n_{i}$* is the number of observations for the *i*th Class Type and *r* is the numbers of the Class Types.

Based on the one-way ANOVA, the mean square treatment (MSTR) is 97538 and the mean square error (MSE) is 1829. The F- test statistic value is 53.33 and the corresponding P-value is close to 0, indicating the significant differences between means of 1st grade math scores in different class sizes. In other words, we conclude that the class sizes have a significant effect on the 1st grade students' math scores. Besides, the residual plot in Figure 4 shows that the resdiuals of different class types are dispersed equally around zero, which indicates the equal variance of the residuals at different factor levels. To quantitatively describe the constancy of the variance at different factor level, the Levene's test is applied and the results are listed in Table 2. Accordingly, the p-value of Levene's test is slightly larger than 0.05 (0.0517), meaning the variance differences at different factor levels are unlikely to occur. At the same time, the residual Q-Q plot shows that the residuals deviate slightly from normality. Plus, the histograms of the residuals in the different class types in Figure 5 support the normality of the residuals at different factor levels. All of these figures demonstrate the appropriateness of the one-way ANOVA model.

Table 1. The summary of the one-way ANOVA.
```{r}
fm1.anova = aov(math1 ~ star1, data = subset1)
summary(fm1.anova)
```

Table 2. The summary of the Levene's test for the constancy of the variance.
```{r}
subset1$res.abs = abs(fm1.anova$residuals)
summary(aov(res.abs~star1, data=subset1))
```

```{r fig.cap = "Figure 4. Residuals vs Fitted and Mormal Q-Q plots."}
par(mfrow=c(1,2), pty="s")
plot(fm1.anova, which=1)
plot(fm1.anova, which=2)
```

```{r fig.cap="Figure 5: Histograms of residuals of 1st grade math scores by different class types."}
par(mfrow=c(2,2), pty="s", xpd = NA)
hist(fm1.anova$residuals[subset1$star1=='regular'], main='Control Group (Regular)', xlab='Residual')
hist(subset1$math1[subset1$star1=='small'], main='Treatment Group I (Small)', xlab='Residual')
hist(subset1$math1[subset1$star1=='regular+aide'], main='Treatment Group II (Regular+Aide)', xlab='Residual')
```

In order to perform a comparison of the means of the math scores in different class type, Three different cutoff-procedures are carried out, namely Bonferroni, Tukey, and Scheffe. The calculation of the cutoff values for each procedure are listed in Table 3.

Table 3. The lists of three different procedure cut-off values
```{r}
alpha = 0.01
m = 3 # number of pairwise differences
B.stat = qt(1-alpha/(2*m), fm1.anova$df.residual)
T.stat = qtukey(1-alpha, length(fm1.anova$coefficients), fm1.anova$df.residual)
S.stat = sqrt(length(fm1.anova$coefficients)-1)*qf(1-alpha,length(fm1.anova$coefficients)-1, fm1.anova$df.residual)
table.stats=matrix(0,1,3);
table.stats[1,]=c(B.stat,T.stat,S.stat);
colnames(table.stats)=c('Bonferroni', 'Tukey', 'Scheffe')

table.stats %>%
  kable() %>%
  kable_styling(full_width = F)
```

Due to the fact that only the comparison between the control group (regular) and the experimental groups (small and regular with aide) are conducted. The narrowest confidence interval are considered, which is using the multiplier generated from the Bonferroni procedure. Here the 99% confidence intervals of the mean comparisons between regular class type and small class type, and regular and regular with aide class types are listed in Table 4. The 99% Bonferroni confidence interval of the mean comparison between regular class type and small class type is from 9.57 to 17.24, which is much higher than 0, indicating that the 1st grade students in the small class perform better in math than those in the regular class on average. At the same time, the positive Bonferroni confidence interval of the mean comparison between regular class type and regular with aide class type means the students in the regular with aide class have a slightly better performace in math than those in the regular class on average.

Table 4. The 99% Bonferroni confidence interval of mean comparisons
```{r}
fm1 <- lm(math1 ~ star1, data = subset1)
u1 <- fm1.anova$coefficients[1]
u2 <- fm1.anova$coefficients[1] + fm1.anova$coefficients[2]
u3 <- fm1.anova$coefficients[1] + fm1.anova$coefficients[3]

n1 = length(subset1$math1[subset1$star1=='regular'])
n2 = length(subset1$math1[subset1$star1=='small'])
n3 = length(subset1$math1[subset1$star1=='regular+aide'])

sd1 = summary(fm1.anova)$sig*sqrt(1/n1)
sd2 = summary(fm1.anova)$sig*sqrt(1/n2)
sd3 = summary(fm1.anova)$sig*sqrt(1/n3)

D12 = fm1.anova$coefficients[2]
sd12 = summary(fm1)$sig*sqrt(1/n1 + 1/n2)

D13 = fm1.anova$coefficients[3]
sd13 = summary(fm1)$sig*sqrt(1/n1 + 1/n3)

# Bonferroni CI
BCI=matrix(0,2,2)
BCI[1,] = c(D12 - B.stat*sd12, D12 + B.stat*sd12) # 99% Bonferroni Correction CI of diff between regular and small
BCI[2,] = c(D13 - B.stat*sd13, D13 + B.stat*sd13) # 99% Bonferroni Correction CI of diff between regular and aide
rownames(BCI) = c("Regular vs Small", "Regular vs Aide")
colnames(BCI) = c("Lower", "Upper")

BCI %>%
  kable() %>%
  kable_styling(full_width = F)
```

Since both intervals do not contain the possible value of mean difference, 0 , the math scores of 1st grade students have a significant association with the class types.

# Conclusion
According to the design of this experiment, the students and teachers are randomly assigned to different levels (class types). Therefore, the potential outcomes, which are the math scores across different class type (treatments), can be obtained. By comparing these math scores between 1st grade students in the regular class type and those in the small class type or regular class type with aide, one causal conclusion can be drawn. The 1st grade students in the small classes perform much better in math than those in the regular classes, while the 1st grade students in the regular classes with aide perform slightly better in math than the regular students.

```{r}
sessionInfo()
```

